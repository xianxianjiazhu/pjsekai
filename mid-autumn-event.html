<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>中秋節活動計算（含倒數）</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* 倒數專用樣式，補充到現有 style.css */
    .subtitle{color:#6b7280;font-size:13px;margin-top:4px}
    .countdown{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .cd-box{background:#f3f4f6;border:1px solid var(--border);border-radius:12px;padding:8px 10px;min-width:90px;text-align:center}
    .cd-num{font-size:20px;font-weight:800}
    .cd-lab{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div class="title">中秋節活動計算</div>
      <div class="subtitle">活動結束：2025/10/13 20:59（台北時間）</div>
      <div class="countdown" id="countdown">
        <div class="cd-box"><div class="cd-num" id="d">—</div><div class="cd-lab">天</div></div>
        <div class="cd-box"><div class="cd-num" id="h">—</div><div class="cd-lab">時</div></div>
        <div class="cd-box"><div class="cd-num" id="m">—</div><div class="cd-lab">分</div></div>
        <div class="cd-box"><div class="cd-num" id="s">—</div><div class="cd-lab">秒</div></div>
      </div>
    </div>

    <!-- 輸入 -->
    <div class="grid">
      <div class="row">
        <div class="label">需要粉絲數</div>
        <div class="field"><input id="needFans" type="text" inputmode="numeric" value="390000" /><div class="unit">粉絲數</div></div>
        <div></div>
      </div>
      <div class="row">
        <div class="label">每首歌可獲得粉絲數</div>
        <div class="field"><input id="perSong" type="text" inputmode="numeric" value="500" /><div class="unit">粉絲數／首</div></div>
        <div></div>
      </div>
      <div class="row">
        <div class="label">現在擁有的粉絲數</div>
        <div class="field"><input id="haveFans" type="text" inputmode="numeric" value="0" /><div class="unit">粉絲數</div></div>
        <div></div>
      </div>
    </div>

    <div class="hint">規則：尚須粉絲 = max(需要 − 現在, 0)；尚須打首歌 = ⌈尚須粉絲 ÷ 每首歌粉絲⌉；平均每天 = ⌈尚須首歌 ÷ 剩餘天數⌉。</div>

    <!-- 結果 -->
    <div class="grid">
      <div class="row">
        <div class="label">尚須粉絲數</div>
        <div class="calc"><input id="remainFans" type="text" value="—" readonly /><div class="unit">粉絲數</div></div>
        <div></div>
      </div>
      <div class="row">
        <div class="label">尚須打</div>
        <div class="calc"><input id="songsNeed" type="text" value="—" readonly /><div class="unit">首歌</div></div>
        <div></div>
      </div>
      <div class="row">
        <div class="label">平均每天打</div>
        <div class="calc"><input id="avgPerDay" type="text" value="—" readonly /><div class="unit">首歌／天</div></div>
        <div></div>
      </div>
    </div>

    <div class="kpi">
      <div class="pill">剩餘天數（含今日）：<span id="daysLeftText">—</span> 天</div>
      <div class="pill">目前進度：<span id="progressPct">0%</span></div>
    </div>

    <div class="footer">
      <button class="primary" id="save">儲存輸入</button>
      <button id="reset">清空</button>
      <span class="note">資料僅存於本機瀏覽器</span>
    </div>
  </div>
</div>

<script>
  const qs=(s)=>document.querySelector(s);
  const fmt=(n)=>isFinite(n)?Number(n).toLocaleString('zh-Hant-TW'):'—';
  const toNum=(s)=>{ if(!s) return NaN; const c=String(s).replace(/[\\,\\s]/g,''); return c===''?NaN:Number(c); };
  const pad2=(n)=>String(n).padStart(2,'0');

  const $needFans=qs('#needFans'),$perSong=qs('#perSong'),$haveFans=qs('#haveFans');
  const $remainFans=qs('#remainFans'),$songsNeed=qs('#songsNeed'),$avgPerDay=qs('#avgPerDay');
  const $progressPct=qs('#progressPct'),$daysLeftText=qs('#daysLeftText');
  const $d=qs('#d'),$h=qs('#h'),$m=qs('#m'),$s=qs('#s');

  const END_LOCAL='2025/10/13 20:59:00';

  function calculate(){
    const need=toNum($needFans.value), per=toNum($perSong.value), have=toNum($haveFans.value);
    const now=new Date(), end=new Date(END_LOCAL.replace(/-/g,'/'));
    const diff=end-now; const ended=diff<=0;

    if(ended){$d.textContent=$h.textContent=$m.textContent=$s.textContent='0';}
    else{
      const sec=Math.floor(diff/1000);
      const days=Math.floor(sec/86400),hours=Math.floor(sec%86400/3600);
      const mins=Math.floor(sec%3600/60),secs=sec%60;
      $d.textContent=days; $h.textContent=pad2(hours);
      $m.textContent=pad2(mins); $s.textContent=pad2(secs);
    }

    let daysLeft=0;if(!ended)daysLeft=Math.ceil(diff/(1000*60*60*24));

    let remain=NaN,songs=NaN,avg=NaN,progress=0;
    if(isFinite(need)&&isFinite(have)&&need>=0&&have>=0){remain=Math.max(need-have,0);progress=need>0?Math.min(have/need,1)*100:0;}
    if(isFinite(remain)&&isFinite(per)&&per>0){songs=Math.ceil(remain/per);}
    if(isFinite(songs)&&daysLeft>0){avg=Math.ceil(songs/daysLeft);}
    else if(isFinite(songs)&&!ended){avg=songs;}
    else if(ended){avg=0;}

    $remainFans.value=isFinite(remain)?fmt(remain):'—';
    $songsNeed.value=isFinite(songs)?fmt(songs):'—';
    $avgPerDay.value=isFinite(avg)?fmt(avg):'—';
    $daysLeftText.textContent=daysLeft||0;
    $progressPct.textContent=progress.toFixed(2)+'%';
  }

  [$needFans,$perSong,$haveFans].forEach($el=>{
    $el.addEventListener('input',calculate);
    $el.addEventListener('blur',e=>{const n=toNum(e.target.value);if(isFinite(n))e.target.value=fmt(n);});
  });

  qs('#save').addEventListener('click',()=>{
    const d={needFans:$needFans.value,perSong:$perSong.value,haveFans:$haveFans.value};
    localStorage.setItem('midAutumnEventInputs',JSON.stringify(d));
    alert('已儲存輸入到本機瀏覽器。');
  });
  qs('#reset').addEventListener('click',()=>{
    [$needFans,$perSong,$haveFans].forEach($=>$.value='');
    calculate();localStorage.removeItem('midAutumnEventInputs');
  });
  (function restore(){
    const raw=localStorage.getItem('midAutumnEventInputs');if(!raw)return;
    try{const d=JSON.parse(raw);if(d.needFans)$needFans.value=d.needFans;if(d.perSong)$perSong.value=d.perSong;if(d.haveFans)$haveFans.value=d.haveFans;}catch(e){}
  })();

  calculate();setInterval(calculate,1000);
</script>
</body>
</html>
